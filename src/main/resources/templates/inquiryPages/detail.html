<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" xmlns:th="http://www.thymeleaf.org">
    <title>문의사항 상세 조회</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <style>
        .container{
            margin-top: 20px;
        }
    </style>
</head>
<body>
<th:block th:replace="commonPages/header :: header"></th:block>
    <div class="container">
        <h3>문의사항 상세 조회</h3>
        <input type="button"  style="float: right;" class="btn btn-outline-dark" th:onclick="'location.href=\''+ @{|/product/${inquiry.inquiryProductId}|} + '\''" value="상품 상세 조회">
        <div th:if="${session.loginId}">
            <input type="button"  style="float: right;" class="btn btn-outline-success" th:if="${#strings.equals(session.loginMemberId, inquiry.inquiryWriter)}" th:onclick="'location.href=\''+ @{|/inquiry/findByInquiryWriter/${inquiry.inquiryWriter}|} + '\''" value="문의사항 목록">
        </div>
        <table class="table">
            <tr>
                <td th:text="'작성자: ' + ${inquiry.inquiryWriter}"></td>
                <td style="font-size: 15px;" th:text="'작성일: ' + *{#temporals.format(inquiry.createdTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
            </tr>
            <tr>
                <td th:text="'제목: ' + ${inquiry.inquiryTitle}"></td>
                <td style="font-size: 15px;" th:if="${inquiry.updatedTime} != null" th:text="'수정일: ' + *{#temporals.format(inquiry.updatedTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
            </tr>
            <tr>
                <td colspan="10" rowspan="20" th:text="${inquiry.inquiryContents}"></td>
            </tr>
        </table>
        <div th:if="${session.loginMemberId}">
            <div th:if="${session.loginMemberId.toString().equals('admin')}" id="comment-write" class="input-group mb-3">
                    관리자 답변 작성 <br>
                    <input type="hidden" id="commentWriter" th:value="${session.loginMemberId}" readonly>
                    <textarea cols="5" rows="5" id="commentContents" class="form-control" placeholder="내용 입력"></textarea>
                    <button id="comment-write-btn" class="btn btn-primary">작성</button>
            </div>
        </div>
        <div id="comment-list">
        관리자 답변
            <table class="table">
                <tr th:each="comment: ${commentList}">
                    <td  colspan="2" th:text="'답변 번호: ' + ${comment.id}"></td>
                </tr>
                <tr>
                    <td th:text="'관리자: ' + ${comment.commentWriter}"></td>
                    <td th:text="'작성시간: ' + *{#temporals.format(comment.createdTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr>
                    <td>내용</td>
                    <td><textarea cols="10" rows="5" th:text="${comment.commentContents}"></textarea> </td>
                </tr>
            </table>
        </div>
    </div>
</body>
<script th:inline="javascript">
    $("#comment-write-btn").click(function (){
        const commentContents = $("#commentContents").val();
        if(commentContents == ""){
            alert("댓글 내용을 작성해 주세요.");
        }
        else{
            $.ajax({
                type: "post",
                url: "/comment/save",
                data: {"commentWriter": [[${session.loginMemberId}]],"commentContents": commentContents, "commentInquiryId": [[${inquiry.id}]]},
                dataType: "json",
                success: function (result){
                    console.log("success");
                    let output = "<table class='table'>";
                    for(let i in result) {
                        output += "<tr><td colspan='2'>" + '답변번호: ' + result[i].id + "</td></tr>";

                        output += "<tr>";
                        output += "<td>" + '관리자: ' + result[i].commentWriter + "</td>";
                        output += "<td>" + '작성시간: ' +moment(result[i].createdTime).format("YYYY-MM-DD HH:mm:ss") + "</td></tr>";

                        output += "<tr>";
                        output += "<th>내용</th>";
                        output += "<td>" + <textarea cols="10" rows="5"> result[i].commentContents </textarea> + "</td>";
                        output += "</tr>";
                    }
                    output += "</table>";
                    document.getElementById("commentResult").innerHTML = output;
                    document.getElementById("commentWriter").value = '[[${session.loginMemberId}]]';
                    document.getElementById('commentContents').value='';
                },
                error:function (){
                    alert("ajax 실패");
                }
            })
        }
    }
</script>
</html>